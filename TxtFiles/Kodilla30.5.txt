USE kodilla_course;
CREATE TABLE STATS(
    STAT_ID INT(11) AUTO_INCREMENT PRIMARY KEY,
    STAT_DATE DATETIME NOT NULL,
    STAT VARCHAR(20) NOT NULL,
    VALUE INT(11) NOT NULL
);

CREATE VIEW BESTSELLERS_COUNT (BESTSELLERS) AS
    SELECT COUNT(*) FROM BOOKS
WHERE BESTSELLER = TRUE;

DELIMITER $$

CREATE EVENT UPDATE_BESTSELLERS
ON SCHEDULE EVERY 1 MINUTE
DO
BEGIN
    CALL UpdateBestsellers();
    insert into STATS (stat_date, stat, value)
        values (CURDATE(), 'BESTSELLERS', (SELECT * FROM BESTSELLERS_COUNT));
    COMMIT;
    END $$
    DELIMITER ;

SELECT * FROM STATS;

DROP EVENT UPDATE_BESTSELLERS;